@model WebAPI.Models.PlanFormViewModel

@{
    var todayDate = DateTime.Now.ToString("yyyy-MM-dd");
    ViewBag.Title = "Create A Plan";
    Layout = "_Layout";
}

<h2 class="text-center display-6">@ViewBag.Title</h2>

<div class="pt-5">
    @using (Html.BeginForm("Index", "Plan",
        null, FormMethod.Post, true, null))
    {
        <div class="row">
            <div class="col-8">
                <div class="form-group form-inline">
                    <input type="text" class="w-100 form-control form-control-lg" id="main-1"
                           name="@Html.DisplayNameFor(m => m.Title)" placeholder="A title for your plan">
                </div>

                <div class="form-group form-inline ">
                    <textarea rows="3" class="w-100 form-control form-control-lg" id="main-2" name="@Html.DisplayNameFor(m => m.Description)" placeholder="What is your plan about"></textarea>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="add-chores-form chores-form p-5 form-group">
                <div class="add-chores-group chores-form-group">
                    <div class="form-group form-row justify-content-between align-top">
                        <input type="text" class="form-control col-5" name="Chores[0].Title" placeholder="Title / what to do"/>
                        <textarea rows="2" class="form-control col-6" name="Chores[0].Description" placeholder="Detailed description"></textarea>
                    </div>
       
                    <div class="add-user-form row form-group">
                        <div class="form-inline add-user-group user-form-group mt-2">
                            <input class="form-control add-user-input w-100" placeholder="add user..."/>
                        </div>
                    </div>
                    
                    <div class="form-group form-inline">
                        <label class="form-label mr-3">
                            Starting Day: <input type="date" class="form-control ml-2" name="Chores[0].StartDay" value="@todayDate"/>
                        </label>
                        <input type="text" class="form-control" name="Chores[0].DayDuration" placeholder="Duration in days" pattern="[1-9]\d*"/>
                    </div>
                </div>
            </div>
        </div>

        <div class="col text-center">
            <input type="submit" id="main-submit" class="w-25 form-control btn btn-primary btn-lg" value="Create">
        </div>
    }
</div>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function() {

            function suppressEnter(e) {
                if (e.keyCode == 13) {
                    e.preventDefault();
                    return false;
                }
            }

            // Do not trigger submit easily (via enter press)
            $("form").keypress(suppressEnter);

            // Prepare the User-Edit-Template
            var templateString =
                '<div class="form-inline user-form-group mr-3 mt-2 pl-2 bg-light">' +
                    '<input class="form-control normal-user-input p-0 bg-light" />' +
                    '<button class="form-control btn btn-remove-user bg-light">' +
                        '<i class="fas fa-times"></i>' +
                    '</button>' +
                '</div>';
            var addUserTemplate = $($.parseHTML(templateString));
            addUserTemplate.keypress(suppressEnter);
            addUserTemplate.keyup(suppressEnter);
            addUserTemplate.keydown(suppressEnter);

            // Add USER Action
            $(".add-user-form").on('keyup.add-user-input',
                function(e) {
                    if (e.keyCode != 13)
                        return;
                    e.preventDefault();
                    var userAdderInput = $('.add-user-input');
                    var userName = userAdderInput.val().trim();
                    if (userName === "")
                        return;
                    
                    var dynamicClone = addUserTemplate.clone(true);
                    var cloneUserInput = $(dynamicClone.children()[0]);
                    
                    cloneUserInput.val(userName);
                    cloneUserInput.attr('size', userName.length );
                    userAdderInput.val("");

                    dynamicClone.insertBefore('.add-user-group');
                });

            // Remove USER Action
            $('.add-user-form').on('click',
                '.btn-remove-user',
                function(e) {
                    e.preventDefault();
                    $(this).closest('.user-form-group').remove();
                    return false;
                });

            // List Data Preparation
            $('form').submit(function(e) {
                $('.add-user-input').remove();

                $('.normal-user-input').each(function(index) {
                    $(this).attr('name', `Chores[0].AssignedUsers[${index}]`);
                });
            });
        });
    </script>
}